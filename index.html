<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World Choice â€“ é€‰æ‹©ä½ çš„ç½‘ç»œå›½å®¶ï¼ˆå…¨çƒç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: #e5e7eb;
    }
    .wrapper {
      max-width: 1120px;
      margin: 24px auto;
      padding: 20px;
      border-radius: 18px;
      background: rgba(15,23,42,0.96);
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.5);
    }
    h1 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 1.8rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
    }
    .col {
      flex: 1 1 320px;
      min-width: 0;
    }
    h2 {
      font-size: 1.1rem;
      margin: 0 0 10px;
    }
    .country-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
    }
    .country-card {
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, border-color 0.1s;
    }
    .country-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      border-color: rgba(59,130,246,0.9);
    }
    .country-card.active {
      border-color: rgba(59,130,246,1);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.8);
      background: radial-gradient(circle at top, rgba(37,99,235,0.35), rgba(15,23,42,0.95));
    }
    .flag {
      font-size: 1.4rem;
    }
    .country-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .country-name {
      font-size: 0.95rem;
    }
    .country-tagline {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .my-choice-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 0.9rem;
    }
    .my-choice-box b {
      font-size: 1rem;
    }
    .stats-box {
      border-radius: 14px;
      background: rgba(3,7,18,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      padding: 10px 12px;
      font-size: 0.9rem;
    }
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .total-number {
      font-weight: 600;
      color: #e5e7eb;
    }
    .ranking-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 380px;
      overflow: auto;
    }
    .ranking-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,1);
    }
    .ranking-top1 {
      border-color: rgba(250,204,21,1);
      background: radial-gradient(circle at top, rgba(250,204,21,0.18), rgba(15,23,42,0.98));
    }
    .ranking-top2 {
      border-color: rgba(96,165,250,1);
    }
    .ranking-top3 {
      border-color: rgba(52,211,153,1);
    }
    .ranking-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    .ranking-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .rank-number {
      width: 20px;
      text-align: right;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .rank-flag {
      font-size: 1.1rem;
    }
    .rank-name {
      font-size: 0.9rem;
    }
    .rank-count {
      font-size: 0.9rem;
      font-variant-numeric: tabular-nums;
    }
    .progress-bar {
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 2px;
    }
    .progress-inner {
      height: 100%;
      width: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      transition: width 0.2s;
    }
    .note {
      margin-top: 8px;
      font-size: 0.78rem;
      color: #9ca3af;
    }
    @media (max-width: 768px) {
      .wrapper { margin: 10px; padding: 14px; }
    }
  </style>
  <!-- Firebase compat SDKï¼ˆç”¨ CDN å°±è¡Œï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="wrapper">
  <h1>World Choice Â· é€‰æ‹©ä½ çš„ç½‘ç»œå›½å®¶ï¼ˆå…¨çƒç‰ˆï¼‰</h1>
  <div class="subtitle">
    åœ¨è¿™ä¸ªç½‘ç«™ä¸Šï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªä½ æƒ³åŠ å…¥çš„â€œç½‘ç»œå›½å®¶â€ï¼Œæˆä¸ºå®ƒçš„å…¬æ°‘ã€‚<br>
    æ‰€æœ‰è®¿é—®è€…çš„é€‰æ‹©éƒ½ä¼šå­˜å…¥äº‘ç«¯æ•°æ®åº“ï¼Œå½¢æˆä¸€ä¸ªçœŸå®çš„â€œå…¨çƒäººæ°”æ’è¡Œæ¦œâ€ã€‚
  </div>

  <div class="layout">
    <!-- å·¦è¾¹ï¼šé€‰æ‹©å›½å®¶ -->
    <div class="col">
      <h2>â‘  é€‰æ‹©ä½ çš„å›½å®¶</h2>
      <div id="countryGrid" class="country-grid"></div>
      <div id="myChoiceBox" class="my-choice-box">
        ä½ è¿˜æ²¡æœ‰é€‰æ‹©å›½å®¶ã€‚ç‚¹å‡»ä¸Šé¢çš„ä»»æ„å¡ç‰‡æ¥é€‰æ‹©ï¼Œä½ å¯ä»¥éšæ—¶æ›´æ¢ã€‚
      </div>
    </div>

    <!-- å³è¾¹ï¼šå…¨çƒäººæ°”ç»Ÿè®¡ -->
    <div class="col">
      <h2>â‘¡ å…¨çƒäººæ°”æ’è¡Œæ¦œ</h2>
      <div class="stats-box">
        <div class="stats-header">
          <span>æ¨¡æ‹Ÿâ€œå…¨çƒå…¬æ°‘æŠ•ç¥¨â€æ•ˆæœ</span>
          <span>æ€»å…¬æ°‘æ•°ï¼š<span id="totalCitizens" class="total-number">0</span></span>
        </div>
        <ol id="rankingList" class="ranking-list"></ol>
        <div class="note">
          å½“å‰æ•°æ®å­˜å‚¨åœ¨ Firebase Firestore ä¸­ï¼Œæ‰€æœ‰è®¿é—®ä½ ç½‘ç«™çš„äººéƒ½ä¼šå…±äº«åŒä¸€ä»½æ•°æ®ã€‚<br>
          ï¼ˆæ³¨æ„ï¼šç›®å‰æ²¡æœ‰ç™»å½•ç³»ç»Ÿï¼Œ1 ä¸ªäººå¯ä»¥å¤šæ¬¡æ¢å›½å®¶ï¼Œä»…ç”¨äºè¶£å‘³ç»Ÿè®¡ï¼‰
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 1. å…ˆå®šä¹‰å›½å®¶åˆ—è¡¨
  const COUNTRIES = [
    { code: "DE", name: "Germany",   emoji: "ğŸ‡©ğŸ‡ª", tagline: "å·¥ç¨‹ã€å•¤é…’å’Œå“²å­¦" },
    { code: "US", name: "USA",       emoji: "ğŸ‡ºğŸ‡¸", tagline: "ç”µå½±ã€ç§‘æŠ€å’Œå¤šå…ƒæ–‡åŒ–" },
    { code: "CN", name: "China",     emoji: "ğŸ‡¨ğŸ‡³", tagline: "å†å²ã€ç¾é£Ÿä¸é€Ÿåº¦" },
    { code: "JP", name: "Japan",     emoji: "ğŸ‡¯ğŸ‡µ", tagline: "äºŒæ¬¡å…ƒã€èŒäººç²¾ç¥" },
    { code: "KR", name: "Korea",     emoji: "ğŸ‡°ğŸ‡·", tagline: "éŸ³ä¹ã€ç”µè§†å‰§ä¸ç¾é£Ÿ" },
    { code: "FR", name: "France",    emoji: "ğŸ‡«ğŸ‡·", tagline: "æµªæ¼«ã€ç¾é…’ä¸è‰ºæœ¯" },
    { code: "IT", name: "Italy",     emoji: "ğŸ‡®ğŸ‡¹", tagline: "æŠ«è¨ã€å¤è¿¹å’Œé˜³å…‰" },
    { code: "ES", name: "Spain",     emoji: "ğŸ‡ªğŸ‡¸", tagline: "è¶³çƒã€é˜³å…‰å’ŒèŠ‚æ—¥" },
    { code: "BR", name: "Brazil",    emoji: "ğŸ‡§ğŸ‡·", tagline: "è¶³çƒä¸çƒ­æƒ…æµ·æ»©" },
    { code: "GB", name: "UK",        emoji: "ğŸ‡¬ğŸ‡§", tagline: "æ‘‡æ»šã€æ–‡å­¦ä¸é›¨" },
    { code: "CA", name: "Canada",    emoji: "ğŸ‡¨ğŸ‡¦", tagline: "æ«å¶ã€æ¹–æ³Šå’Œå‹å–„" },
    { code: "AU", name: "Australia", emoji: "ğŸ‡¦ğŸ‡º", tagline: "å¤§æµ·ã€é˜³å…‰å’Œè¢‹é¼ " }
  ];

  // 2. è¿™é‡Œè¦å¡«ä½ çš„ Firebase é…ç½®ï¼ˆç¬¬ 2 æ­¥ä¼šæ•™ä½ æ€ä¹ˆæ‹¿åˆ°ï¼‰
  const firebaseConfig = {
    // TODO: ç”¨ä½ è‡ªå·±çš„é…ç½®æ›¿æ¢è¿™é‡Œçš„å†…å®¹
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // 3. åˆå§‹åŒ– Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const countryGrid   = document.getElementById("countryGrid");
  const myChoiceBox   = document.getElementById("myChoiceBox");
  const rankingList   = document.getElementById("rankingList");
  const totalCitizens = document.getElementById("totalCitizens");

  let myCountryCode = localStorage.getItem("myCountryCode") || null;

  // æ¸²æŸ“å›½å®¶å¡ç‰‡
  function renderCountryGrid() {
    countryGrid.innerHTML = "";
    COUNTRIES.forEach(c => {
      const card = document.createElement("div");
      card.className = "country-card";
      card.dataset.code = c.code;

      if (myCountryCode === c.code) {
        card.classList.add("active");
      }

      card.innerHTML = `
        <div class="flag">${c.emoji}</div>
        <div class="country-info">
          <div class="country-name">${c.name}</div>
          <div class="country-tagline">${c.tagline}</div>
        </div>
      `;

      card.addEventListener("click", () => selectCountry(c.code));
      countryGrid.appendChild(card);
    });

    updateMyChoiceText();
  }

  function updateMyChoiceText() {
    if (!myCountryCode) {
      myChoiceBox.innerHTML = "ä½ è¿˜æ²¡æœ‰é€‰æ‹©å›½å®¶ã€‚ç‚¹å‡»ä¸Šé¢çš„ä»»æ„å¡ç‰‡æ¥é€‰æ‹©ï¼Œä½ å¯ä»¥éšæ—¶æ›´æ¢ã€‚";
      return;
    }
    const c = COUNTRIES.find(x => x.code === myCountryCode);
    if (!c) {
      myChoiceBox.innerHTML = "å½“å‰é€‰æ‹©çš„å›½å®¶å·²ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚";
      return;
    }
    myChoiceBox.innerHTML = `
      ä½ å½“å‰çš„ç½‘ç»œå›½ç±æ˜¯ï¼š<b>${c.emoji} ${c.name}</b><br>
      å¦‚æœä½ å†æ¬¡ç‚¹å‡»å…¶ä»–å›½å®¶ï¼Œä½ ä¼šè‡ªåŠ¨ä»åŸå›½å®¶â€œè¿å‡ºâ€ï¼ŒåŠ å…¥æ–°çš„å›½å®¶ã€‚
    `;
  }

  // é€‰æ‹©å›½å®¶ï¼šæ›´æ–° Firestore + æœ¬åœ°çŠ¶æ€
  async function selectCountry(newCode) {
    if (!firebase.apps.length) return;

    const oldCode = myCountryCode;
    if (oldCode === newCode) {
      // å·²ç»æ˜¯è¿™ä¸ªå›½å®¶äº†ï¼Œä¸ç”¨é‡å¤æ“ä½œ
      return;
    }

    // ä¹è§‚ UIï¼šå…ˆæ›´æ–°å‰ç«¯
    myCountryCode = newCode;
    localStorage.setItem("myCountryCode", newCode);
    renderCountryGrid();

    try {
      const countriesCol = db.collection("countries");
      const batch = db.batch();

      const newRef = countriesCol.doc(newCode);
      batch.set(newRef, { count: firebase.firestore.FieldValue.increment(1) }, { merge: true });

      if (oldCode) {
        const oldRef = countriesCol.doc(oldCode);
        batch.set(oldRef, { count: firebase.firestore.FieldValue.increment(-1) }, { merge: true });
      }

      await batch.commit();
    } catch (err) {
      console.error("æ›´æ–°å›½å®¶é€‰æ‹©å¤±è´¥ï¼š", err);
      alert("æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€‚ä½ å¯ä»¥ç¨ååˆ·æ–°é¡µé¢é‡è¯•ã€‚");
    }
  }

  // å®æ—¶ç›‘å¬ countries é›†åˆï¼Œæ›´æ–°æ’è¡Œæ¦œ
  function subscribeRanking() {
    db.collection("countries").onSnapshot(snapshot => {
      const arr = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        const count = typeof data.count === "number" ? data.count : 0;
        if (count < 0) data.count = 0;
        arr.push({ code: doc.id, count: Math.max(0, count) });
      });

      // åŠ ä¸Šé‚£äº›è¿˜æ²¡æœ‰ doc çš„å›½å®¶ï¼ˆcount=0ï¼‰
      COUNTRIES.forEach(c => {
        if (!arr.find(x => x.code === c.code)) {
          arr.push({ code: c.code, count: 0 });
        }
      });

      // æ’åºï¼šäººæ•°ä»å¤šåˆ°å°‘
      arr.sort((a, b) => b.count - a.count);

      const total = arr.reduce((sum, x) => sum + x.count, 0);
      totalCitizens.textContent = total;

      rankingList.innerHTML = "";
      arr.forEach((item, index) => {
        const c = COUNTRIES.find(x => x.code === item.code);
        if (!c) return;  // å¿½ç•¥æœªçŸ¥ code

        const li = document.createElement("li");
        li.className = "ranking-item";
        if (index === 0) li.classList.add("ranking-top1");
        else if (index === 1) li.classList.add("ranking-top2");
        else if (index === 2) li.classList.add("ranking-top3");

        const percentage = total > 0 ? (item.count / total * 100) : 0;

        li.innerHTML = `
          <div class="ranking-row">
            <div class="ranking-left">
              <span class="rank-number">${index + 1}</span>
              <span class="rank-flag">${c.emoji}</span>
              <span class="rank-name">${c.name}</span>
            </div>
            <div class="rank-count">${item.count}</div>
          </div>
          <div class="progress-bar">
            <div class="progress-inner" style="width:${percentage.toFixed(1)}%;"></div>
          </div>
        `;
        rankingList.appendChild(li);
      });
    }, err => {
      console.error("ç›‘å¬æ’è¡Œæ¦œå¤±è´¥ï¼š", err);
    });
  }

  // åˆå§‹åŒ–
  renderCountryGrid();
  subscribeRanking();
</script>
</body>
</html>